name: Build & Test

on:
  push:
    branches:
      - "**"

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-code:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup nodeJS
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Linting code
        run: npx eslint src

      - name: Build code
        run: ./node_modules/.bin/ncc build src/index.ts -o output

      - name: Check committed build files
        run: diff -r dist output

  release:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    permissions:
      contents: write

    needs:
      - check-code

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Get version from package.json
        id: version
        run: |
          VERSION=$(jq -r '.version' package.json)
          MAJOR_VERSION=$(echo "$VERSION" | cut -d. -f1)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "major_version=$MAJOR_VERSION" >> "$GITHUB_OUTPUT"

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
        run: gh release create "v${{ steps.version.outputs.version }}" --generate-notes

      - name: Update major version tag
        env:
          GH_TOKEN: ${{ github.token }}
          MAJOR_TAG: v${{ steps.version.outputs.major_version }}
        run: |
          # Delete existing major version tag (local and remote)
          git tag -d "$MAJOR_TAG" 2>/dev/null || true
          git push origin --delete "$MAJOR_TAG" 2>/dev/null || true

          # Create new major version tag pointing to current commit
          git tag "$MAJOR_TAG"
          git push origin "$MAJOR_TAG"

      - name: Update major version release
        env:
          GH_TOKEN: ${{ github.token }}
          MAJOR_TAG: v${{ steps.version.outputs.major_version }}
        run: |
          # Delete existing major version release if it exists
          gh release delete "$MAJOR_TAG" --yes 2>/dev/null || true

          # Create major version release
          gh release create "$MAJOR_TAG" \
            --title "$MAJOR_TAG" \
            --notes "Latest $MAJOR_TAG release. See [v${{ steps.version.outputs.version }}](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}) for details."

  send-notification:
    runs-on: ubuntu-latest
    if: always()

    permissions:
      id-token: write

    needs:
      - check-code
      - release

    steps:
      - name: Send Slack notification
        uses: ruchira088/slack-github-action@v1
